<link rel="import" href="../polymer/polymer.html">
<script type="text/javascript" src="../d3/d3.min.js"></script>
<script type="text/javascript" src="./js/sankey.js"></script>


<!--
`sankey-composition`
The element is showing a set of glycan composition in a sankey

@demo demo/index.html
-->

<dom-module id="sankey-composition">
  <template>
    <style>
      :host {
        display: block;
      }

      .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
      }

      .linkFuc {
        fill: none;
        stroke: #c94c4c;
        stroke-opacity: .5;
      }

      .linkFuc:hover {
        stroke-opacity: 1;
      }

      .linkHex {
        fill: none;
        stroke: #4040a1;
        stroke-opacity: .5;
      }

      .linkHex:hover {
        stroke-opacity: 1;
      }

      .linkHexNAc {
        fill: none;
        stroke: #D2691E;
        stroke-opacity: .5;
      }

      .linkHexNAc:hover {
        stroke-opacity: 1;
      }

      .linkNeuAc {
        fill: none;
        stroke: #b8a9c9;
        stroke-opacity: .5;
      }

      .linkNeuAc:hover {
        stroke-opacity: 1;
      }

      .linkNeuGc {
        fill: none;
        stroke: #d5f4e6;
        stroke-opacity: .5;
      }

      .linkNeuGc:hover {
        stroke-opacity: 1;
      }

      .svg-container {
        display: inline-block;
        position: relative;
        width: 100%;
        padding-bottom: 80%; /* aspect ratio */
        vertical-align: top;
        overflow: hidden;
      }
      .svg-content-responsive {
        display: inline-block;
        position: absolute;
        top: 10px;
        left: 0;
      }


      .slider {
        position: relative;
        top: 40px;
        left: 40px;
      }

      .slider-tray {
        position: absolute;
        width: 100%;
        height: 6px;
        border: solid 1px #ccc;
        border-top-color: #aaa;
        border-radius: 4px;
        background-color: #f0f0f0;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.08);
      }

      .slider-handle {
        position: absolute;
        top: 3px;
      }

      .slider-handle-icon {
        width: 14px;
        height: 14px;
        border: solid 1px #aaa;
        position: absolute;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        top: -7px;
        left: -7px;
      }
    </style>
    <div>
      <p id="chart"></p>
      <div id="slider"></div>
    </div>


  </template>

  <script>

    // Private variables. Not needed in Polymer.
    var linearScale = {};
    var sliderValue = 0;

    Polymer({
      is: 'sankey-composition',
      properties: {

        selectedExperiment: {
          type: String,
          reflectToAttribute: true,
          observer: '_selectedExperimentChanged'
        },

        selectedStructure: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        width: {
          type: Number,
          value: 1200
        },

        height: {
          type: Number,
          value: 800
        },

        initSankey: {
          type: Boolean,
          value: false
        },
      },

      created: function () {
        //check d3
        //todo: fix loading d3. Must be loaded only if is not present.

      },

      ready: function(){
        // Way to force polymer to apply style to D3 svg.
        this.scopeSubtree(this.$.chart, true);

        var margin = {top: 6, right: 1, bottom: 6, left: 1};

        this.width = this.width - margin.left - margin.right;
        this.height = this.height - margin.top - margin.bottom;

        this.sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .size([this.width, this.height]);

        this.path = this.sankey.link();

        this.svg = d3.select(this.$.chart)
                .append("div")
                .classed("svg-container", true) //container class to make it responsive
                .append("svg")
                .attr("preserveAspectRatio", "xMinYMin meet")
                .attr("viewBox", "0 0 1200 800")
                //class to make it responsive
                .classed("svg-content-responsive", true)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      },


      _createSankey: function (dataExp) {

        var format = d3.format(",.0f");
        var sankey = this.sankey;
        var path = this.path;
        var height = this.height;

        var maxIntensity = Math.max.apply(Math,dataExp.nodes.map(function(o){return o.percentage;}));

        linearScale = d3.scale.linear()
                .domain([0,0.5,1,maxIntensity])
                .range([0, this.width/3, (2*this.width)/3,this.width])
                .clamp(true);

        //Not elegant but needed to change a polymer property from d3 (wrap context this into that).
        var that = this;

        sankey.nodes(dataExp.nodes).links(dataExp.links).layout(32);

        var link = this.svg.append("g").selectAll(".link")
                .data(dataExp.links)
                .enter().append("path")
                .attr("class", function(d) { return "link"+d.difference+ " link"; })
                .attr("d", path)
                .style("stroke-width", 4)
                .sort(function(a, b) { return b.dy - a.dy; });

        link.append("title")
                .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + d.value+" "+d.difference; });

        var node = this.svg.append("g").selectAll(".node")
                .data(dataExp.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                .on("click",function(e){
                  that.selectedStructure = e.unicarbEncoding;
                })
                .call(d3.behavior.drag()
                        .origin(function(d) { return d; })
                        .on("drag", dragmove));

        node.append("rect")
                .attr("height", function(d) { return d.dy; })
                .attr("width", sankey.nodeWidth())
                .style("fill", function(d) {
                  var p = parseFloat(d.percentage);
                  if(p == -1){
                    return 'grey';
                  } else if(p === 0){
                    return 'white';
                  } else if(p < 1 && p > 0){
                    return 'yellow';
                  } else if(p > 1){
                    return 'green';
                  }
                })
                .style("stroke", 'black')
                .append("title")
                .text(function(d) { return d.name + "\n" + format(d.value); });

        node.append("text")
                .attr("x", -6)
                .attr("y", function(d) { return d.dy / 2; })
                .attr("dy", ".35em")
                .attr("text-anchor", "end")
                .attr("transform", null)
                .text(function(d) { return d.name; })
                .filter(function(d) { return d.x < 1; })
                .attr("x", 6 + sankey.nodeWidth())
                .attr("text-anchor", "start");

        this.initSankey = true;

        function dragmove(d) {
          d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
          sankey.relayout();
          link.attr("d", path);
        }

        this._addSlider();
      },

      _selectedExperimentChanged: function (newValue){

        if(newValue == ''){
          return;
        }

        var dataExp = JSON.parse(localStorage.getItem(newValue)).data;

        if(Object.keys(dataExp).length === 0 && dataExp.constructor === Object){
          return;
        }

        if(this.initSankey){
          this._updateSankey(dataExp);
        } else{
          this._createSankey(dataExp);
        }
      },


      _updateSankey: function (dataExp){

        var maxIntensity = Math.max.apply(Math,dataExp.nodes.map(function(o){return o.percentage;}));

        linearScale = d3.scale.linear()
                .domain([0,0.5,1,maxIntensity])
                .range([0, this.width/3, (2*this.width)/3,this.width])
                .clamp(true);

        if(sliderValue > maxIntensity){
          sliderValue = maxIntensity;
        }

        this.sankey.nodes(dataExp.nodes)
                .links(dataExp.links)
                .size([this.width, this.height])
                .layout(32);


        var nodes = this.svg.selectAll(".node")
                .data(dataExp.nodes)
                .transition()
                .duration(1000)
                .attr("transform", function(d) {
                  return "translate(" + d.x + "," + d.y + ")"; });

        this.svg.selectAll("rect")
                .data(dataExp.nodes)
                .transition()
                .duration(1000)
                .attr("height", function(d) { return d.dy; })
                .attr("width", this.sankey.nodeWidth())

                .style("fill", function(d) {
                  var p = parseFloat(d.percentage);
                  if(p == -1){
                    return 'grey';
                  } else if(p === 0){
                    return 'white';
                  } else if(p < 1 && p > 0){
                    return 'yellow';
                  } else if(p > 1){
                    return 'green';
                  }
                });

        this.svg.selectAll("text")
                .data(dataExp.nodes).attr("x", -6)
                .attr("y", function(d) { return d.dy / 2; })
                .attr("dy", ".35em")
                .attr("text-anchor", "end")
                .attr("transform", null)
                .text(function(d) { return d.name; })
                .filter(function(d) { return d.x < 1; })
                .attr("x", 6 + this.sankey.nodeWidth())
                .attr("text-anchor", "start");

        var links = this.svg.selectAll(".link")
                .data(dataExp.links)
                .transition()
                .duration(1000)
                .attr("d", this.path)
                .attr("class", function(d) { return "link"+d.difference+ " link"; })
                .style("stroke-width", function (d) {
                  return 4;
                })
                .sort(function(a, b) {
                  return b.dy - a.dy; });

        links.select('title').remove();

        this.svg.selectAll(".link").append("title").text(function(d) { return d.source.name + " → " + d.target.name + "\n" + d.value+" "+d.difference; });

      },

      _addSlider: function (){

        var chart = this.$.chart;
        var dispatch = d3.dispatch("sliderChange");

        var slider = d3.select(this.$.slider)
                .style("width","500px");


        var sliderTray = slider.append("div")
                .attr("class", "slider-tray");

        var sliderHandle = slider.append("div")
                .attr("class", "slider-handle");

        sliderHandle.append("div")
                .attr("class", "slider-handle-icon");

        slider.call(d3.behavior.drag()
                .on("dragstart", function() {
                  dispatch.sliderChange(linearScale.invert(d3.mouse(sliderTray.node())[0]));
                  d3.event.sourceEvent.preventDefault();
                })
                .on("drag", function() {
                  dispatch.sliderChange(linearScale.invert(d3.mouse(sliderTray.node())[0]));
                }));

        dispatch.on("sliderChange.slider", function(value) {
          sliderHandle.style("left", linearScale(value) + "px");
          d3.select(chart).selectAll('.link').style("stroke-width", function (d) {
            sliderValue = value;
            if (d.source.value > value && d.target.value > value) {
              return 4;
            } else {
              return 0;
            }
          })
        });
      }

    });

  </script>
</dom-module>
